<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKIT Course Analyzer - Local Demo</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .api-key-section {
            background: #f0f8ff;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .api-key-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
        }
        .api-status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .api-status.ready {
            background: #d4edda;
            color: #155724;
        }
        .api-status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .demo-notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö HKIT Course Analyzer</h1>
            <p class="subtitle">Advanced Standing Analysis Tool - Local Demo Version</p>
        </header>

        <div class="demo-notice">
            <strong>üìå Local Demo Mode:</strong> This version runs entirely in your browser. 
            Your API key is stored locally and never sent to any server.
        </div>

        <!-- API Key Configuration Section -->
        <div class="api-key-section">
            <h3>üîë Step 1: Configure Gemini API Key</h3>
            <p>Enter your Google Gemini API key to enable the analysis features:</p>
            <input 
                type="password" 
                id="api-key-input" 
                class="api-key-input" 
                placeholder="Enter your Gemini API key (starts with AIza...)"
            >
            <button onclick="saveApiKey()" class="btn btn-primary">Save API Key</button>
            <button onclick="toggleKeyVisibility()" class="btn btn-secondary">Show/Hide Key</button>
            <button onclick="clearApiKey()" class="btn btn-secondary">Clear Key</button>
            <div id="api-status" class="api-status"></div>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                Don't have an API key? 
                <a href="https://makersuite.google.com/app/apikey" target="_blank">Get one free from Google</a>
            </p>
        </div>

        <main>
            <!-- File Upload Section -->
            <section class="upload-section" id="upload-section" style="display: none;">
                <h2>üìÑ Step 2: Upload Your Documents</h2>
                <div class="upload-container">
                    <div class="upload-box">
                        <label for="transcript-upload" class="upload-label">
                            <div class="upload-icon">üìã</div>
                            <div class="upload-text">
                                <strong>HKIT Transcript (PDF)</strong>
                                <span>Click to browse or drag and drop</span>
                            </div>
                        </label>
                        <input type="file" id="transcript-upload" accept=".pdf" hidden>
                        <div id="transcript-status" class="file-status"></div>
                    </div>
                </div>
            </section>

            <!-- University Selection -->
            <section class="university-section" id="university-section" style="display: none;">
                <h2>üè´ Step 3: Select Target University</h2>
                <div class="university-grid">
                    <button class="university-btn" data-university="polyu">
                        <div class="uni-icon">üéì</div>
                        <div class="uni-name">PolyU</div>
                        <div class="uni-program">Computing/Business</div>
                    </button>
                    <button class="university-btn" data-university="cityu">
                        <div class="uni-icon">üèõÔ∏è</div>
                        <div class="uni-name">CityU</div>
                        <div class="uni-program">CS/IS Programs</div>
                    </button>
                    <button class="university-btn" data-university="hku">
                        <div class="uni-icon">üåü</div>
                        <div class="uni-name">HKU</div>
                        <div class="uni-program">Engineering</div>
                    </button>
                    <button class="university-btn" data-university="custom">
                        <div class="uni-icon">‚öôÔ∏è</div>
                        <div class="uni-name">Custom</div>
                        <div class="uni-program">Manual Mapping</div>
                    </button>
                </div>
            </section>

            <!-- Analysis Button -->
            <section class="action-section" id="action-section" style="display: none;">
                <button id="analyze-btn" class="btn btn-analyze" disabled>
                    <span class="btn-icon">üîç</span>
                    <span class="btn-text">Analyze Transcript</span>
                </button>
                <div id="analysis-progress"></div>
            </section>

            <!-- Results Section -->
            <section class="results-section" id="results-section" style="display: none;">
                <h2>üìä Analysis Results</h2>
                <div id="results-container"></div>
                <div class="export-buttons">
                    <button onclick="exportToCSV()" class="btn btn-export">
                        <span class="btn-icon">üíæ</span>
                        Export to CSV
                    </button>
                    <button onclick="printResults()" class="btn btn-secondary">
                        <span class="btn-icon">üñ®Ô∏è</span>
                        Print Report
                    </button>
                </div>
            </section>
        </main>

        <footer>
            <p>Local Demo Version | Data processed locally in your browser</p>
        </footer>
    </div>

    <!-- Load PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Local Demo Script -->
    <script>
        // Local storage key for API key
        const API_KEY_STORAGE = 'gemini_api_key_local';
        let currentApiKey = null;

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkApiKey();
        });

        // Check if API key exists
        function checkApiKey() {
            const savedKey = localStorage.getItem(API_KEY_STORAGE);
            if (savedKey) {
                document.getElementById('api-key-input').value = savedKey;
                currentApiKey = savedKey;
                validateApiKey();
            } else {
                updateApiStatus('Please enter your Gemini API key to continue', 'error');
            }
        }

        // Save API key
        function saveApiKey() {
            const keyInput = document.getElementById('api-key-input');
            const apiKey = keyInput.value.trim();
            
            if (!apiKey) {
                updateApiStatus('Please enter an API key', 'error');
                return;
            }

            if (!apiKey.startsWith('AIza')) {
                updateApiStatus('Invalid API key format (should start with AIza...)', 'error');
                return;
            }

            localStorage.setItem(API_KEY_STORAGE, apiKey);
            currentApiKey = apiKey;
            validateApiKey();
        }

        // Validate API key
        async function validateApiKey() {
            updateApiStatus('Validating API key...', '');
            
            try {
                // Test the API key with a simple request
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${currentApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: "Say 'OK' if this works"
                            }]
                        }]
                    })
                });

                if (response.ok) {
                    updateApiStatus('‚úÖ API key validated successfully!', 'ready');
                    enableApplication();
                } else {
                    const error = await response.json();
                    updateApiStatus(`‚ùå Invalid API key: ${error.error?.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                updateApiStatus(`‚ùå Failed to validate: ${error.message}`, 'error');
            }
        }

        // Update API status display
        function updateApiStatus(message, status) {
            const statusDiv = document.getElementById('api-status');
            statusDiv.textContent = message;
            statusDiv.className = 'api-status ' + status;
        }

        // Enable application after API key validation
        function enableApplication() {
            document.getElementById('upload-section').style.display = 'block';
            document.getElementById('university-section').style.display = 'block';
            document.getElementById('action-section').style.display = 'block';
        }

        // Toggle API key visibility
        function toggleKeyVisibility() {
            const input = document.getElementById('api-key-input');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // Clear API key
        function clearApiKey() {
            if (confirm('Are you sure you want to clear the API key?')) {
                localStorage.removeItem(API_KEY_STORAGE);
                document.getElementById('api-key-input').value = '';
                currentApiKey = null;
                updateApiStatus('API key cleared', '');
                document.getElementById('upload-section').style.display = 'none';
                document.getElementById('university-section').style.display = 'none';
                document.getElementById('action-section').style.display = 'none';
            }
        }

        // Call Gemini API directly from browser
        async function callGeminiAPI(prompt) {
            if (!currentApiKey) {
                throw new Error('API key not configured');
            }

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${currentApiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 8192,
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API request failed');
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // Export results to CSV
        function exportToCSV() {
            // Implementation for CSV export
            alert('Export functionality will be implemented based on your results format');
        }

        // Print results
        function printResults() {
            window.print();
        }
    </script>

    <!-- Load application modules -->
    <script src="assets/js/pdf-parser.js"></script>
    <script src="config/course-data.js"></script>
    <script>
        // Modified app.js for local demo
        let transcriptData = null;
        let selectedUniversity = null;

        // File upload handlers
        document.getElementById('transcript-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const status = document.getElementById('transcript-status');
                status.textContent = 'Processing PDF...';
                
                try {
                    transcriptData = await PDFParser.parseTranscript(file);
                    status.textContent = `‚úÖ Loaded: ${transcriptData.courses.length} courses found`;
                    checkReadyToAnalyze();
                } catch (error) {
                    status.textContent = `‚ùå Error: ${error.message}`;
                }
            }
        });

        // University selection
        document.querySelectorAll('.university-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.university-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedUniversity = btn.dataset.university;
                checkReadyToAnalyze();
            });
        });

        // Check if ready to analyze
        function checkReadyToAnalyze() {
            const analyzeBtn = document.getElementById('analyze-btn');
            if (transcriptData && selectedUniversity) {
                analyzeBtn.disabled = false;
            }
        }

        // Analyze button handler
        document.getElementById('analyze-btn').addEventListener('click', async () => {
            const resultsSection = document.getElementById('results-section');
            const resultsContainer = document.getElementById('results-container');
            const progressDiv = document.getElementById('analysis-progress');
            
            progressDiv.innerHTML = '<div class="loading">üîÑ Analyzing transcript with Gemini AI...</div>';
            
            try {
                // Create analysis prompt
                const prompt = createAnalysisPrompt(transcriptData, selectedUniversity);
                
                // Call Gemini API
                const result = await callGeminiAPI(prompt);
                
                // Display results
                resultsContainer.innerHTML = formatResults(result);
                resultsSection.style.display = 'block';
                progressDiv.innerHTML = '';
                
            } catch (error) {
                progressDiv.innerHTML = `<div class="error">‚ùå Analysis failed: ${error.message}</div>`;
            }
        });

        // Create analysis prompt
        function createAnalysisPrompt(transcript, university) {
            const courseList = transcript.courses.map(c => 
                `${c.code}: ${c.name} (Grade: ${c.grade}, Credits: ${c.credits})`
            ).join('\n');

            return `Analyze these HKIT courses for advanced standing at ${university}:

${courseList}

Please provide:
1. Which courses are likely to receive exemption
2. Equivalent university courses
3. Total credits that can be transferred
4. Recommendations for maximizing advanced standing

Format the response in a clear, structured way.`;
        }

        // Format results for display
        function formatResults(resultText) {
            // Convert markdown-style text to HTML
            return `<div class="results-content">
                <pre style="white-space: pre-wrap; font-family: inherit;">${resultText}</pre>
            </div>`;
        }
    </script>
</body>
</html>
