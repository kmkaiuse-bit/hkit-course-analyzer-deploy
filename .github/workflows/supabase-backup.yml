# Supabase è‡ªå‹•å‚™ä»½å·¥ä½œæµç¨‹
# æ¯å¤©å‡Œæ™¨ 2:00 (UTC) è‡ªå‹•å‚™ä»½æ•¸æ“šåº« = é¦™æ¸¯æ™‚é–“ä¸Šåˆ 10:00
# å…è²»ä½¿ç”¨ GitHub Actions

name: Supabase Database Backup

on:
  # æ¯å¤©è‡ªå‹•é‹è¡Œ (UTC æ™‚é–“ 02:00 = é¦™æ¸¯æ™‚é–“ 10:00)
  schedule:
    - cron: '0 2 * * *'

  # å…è¨±æ‰‹å‹•è§¸ç™¼å‚™ä»½
  workflow_dispatch:

  # æ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯æ™‚ä¹Ÿå‚™ä»½ (å¯é¸)
  # push:
  #   branches: [main]

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      # æ­¥é©Ÿ 1: æª¢å‡ºä»£ç¢¼
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ­¥é©Ÿ 2: è¨­ç½® Supabase CLI
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # æ­¥é©Ÿ 3: å‰µå»ºå‚™ä»½ç›®éŒ„
      - name: Create backup directory
        run: |
          mkdir -p backups
          echo "Backup directory created"

      # æ­¥é©Ÿ 4: å‚™ä»½æ•¸æ“šåº« (å®Œæ•´å‚™ä»½)
      - name: Backup Supabase Database
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          # ç”Ÿæˆæ™‚é–“æˆ³
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          BACKUP_FILE="backups/supabase_backup_${TIMESTAMP}.sql"

          echo "Creating backup: ${BACKUP_FILE}"

          # ä½¿ç”¨ Supabase CLI å‚™ä»½
          supabase db dump --db-url "$SUPABASE_DB_URL" -f "$BACKUP_FILE"

          # æª¢æŸ¥æ–‡ä»¶å¤§å°
          if [ -f "$BACKUP_FILE" ]; then
            SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
            echo "Backup created successfully: ${SIZE}"
            echo "BACKUP_FILE=${BACKUP_FILE}" >> $GITHUB_ENV
            echo "BACKUP_SIZE=${SIZE}" >> $GITHUB_ENV
          else
            echo "Error: Backup file not created"
            exit 1
          fi

      # æ­¥é©Ÿ 5: å£“ç¸®å‚™ä»½ (ç¯€çœç©ºé–“)
      - name: Compress backup
        run: |
          gzip -9 "$BACKUP_FILE"
          echo "Backup compressed: ${BACKUP_FILE}.gz"
          echo "BACKUP_FILE_GZ=${BACKUP_FILE}.gz" >> $GITHUB_ENV

      # æ­¥é©Ÿ 6: ä¸Šå‚³å‚™ä»½ç‚º Artifact (ä¿ç•™ 30 å¤©)
      - name: Upload backup as artifact
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-${{ github.run_number }}
          path: ${{ env.BACKUP_FILE_GZ }}
          retention-days: 30

      # æ­¥é©Ÿ 7: æäº¤å‚™ä»½åˆ° Git (å¯é¸ - åƒ…ä¿ç•™æœ€è¿‘ 7 å¤©)
      - name: Commit backup to repository
        run: |
          # é…ç½® Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # åªä¿ç•™æœ€è¿‘ 7 å¤©çš„å‚™ä»½
          find backups -name "*.sql.gz" -mtime +7 -delete

          # æ·»åŠ æ–°å‚™ä»½
          git add backups/*.gz

          # æäº¤ (å¦‚æœæœ‰è®ŠåŒ–)
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
            git commit -m "chore: auto backup Supabase database - ${TIMESTAMP}"
            git push
          fi

      # æ­¥é©Ÿ 8: ç™¼é€é€šçŸ¥ (æˆåŠŸ)
      - name: Backup summary
        if: success()
        run: |
          echo "âœ… Backup completed successfully!"
          echo "ğŸ“ File: ${{ env.BACKUP_FILE_GZ }}"
          echo "ğŸ“Š Size: ${{ env.BACKUP_SIZE }}"
          echo "ğŸ• Time: $(date)"
          echo "ğŸ”— Download: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      # æ­¥é©Ÿ 9: ç™¼é€é€šçŸ¥ (å¤±æ•—)
      - name: Backup failed notification
        if: failure()
        run: |
          echo "âŒ Backup failed!"
          echo "Please check the logs for details"
          echo "ğŸ”— Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
